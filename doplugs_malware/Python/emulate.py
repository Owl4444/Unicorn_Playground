"""
This script is used to emulate some code or function or portions 
of functions that are self contained. For this case, this script
is used to decrypt some strings which is used for function resolution. 
This reveals the function names that is used.

There are three memory mapped region:
1. Stack
2. Code
3. rData

The rDAta section contains information for xor key and the encrypted data 
for resolving the function. Refer to IDA for such case.

Example:

```c
    v21 = -1165784167;
    v22[0] = 0;
    v12 = _mm_loadl_epi64((&v19 + 1));
    v13 = _mm_and_si128(_mm_xor_si128(_mm_unpacklo_epi8(v12, v12), xmmword_1007F160), xmmword_1007F170);
    *(&v19 + 1) = _mm_packus_epi16(v13, v13).m128i_u64[0];
    do
    {
      v22[v11] ^= (v11 - 124) ^ 0x78;
      ++v11;
    }
    while ( v11 );
```

Whose disassembly is:

```
.text:10001828 C7 44 24 0C 57 73 6B                 mov     dword ptr [esp+48h+var_3C], 776B7357h
.text:10001828 77
.text:10001830 C7 44 24 10 61 43 6F                 mov     dword ptr [esp+48h+var_3C+4], 6B6F4361h
.text:10001830 6B
.text:10001838 66 C7 44 24 14 9D 00                 mov     [esp+48h+var_34], 9Dh
.text:1000183F 89 C6                                mov     esi, eax
.text:10001841 B8 F5 FF FF FF                       mov     eax, 0FFFFFFF5h
.text:10001846 C7 44 24 18 4C 6E 63                 mov     dword ptr [esp+48h+var_30], 67636E4Ch
.text:10001846 67
.text:1000184E C7 44 24 1C 48 6C 64                 mov     [esp+48h+var_2C], 75646C48h
.text:1000184E 75
.text:10001856 C7 44 24 20 99 8B 83                 mov     [esp+48h+var_28], 0BA838B99h
.text:10001856 BA
.text:1000185E 88 5C 24 24                          mov     [esp+48h+var_24], bl
.text:10001862 F3 0F 7E 44 24 0D                    movq    xmm0, [esp+48h+var_3C+1]
.text:10001868 66 0F 60 C0                          punpcklbw xmm0, xmm0
.text:1000186C 66 0F EF 05 60 F1 07                 pxor    xmm0, ds:xmmword_1007F160
.text:1000186C 10
.text:10001874 66 0F DB 05 70 F1 07                 pand    xmm0, ds:xmmword_1007F170
.text:10001874 10
.text:1000187C 66 0F 67 C0                          packuswb xmm0, xmm0
.text:10001880 66 0F D6 44 24 0D                    movq    [esp+48h+var_3C+1], xmm0
.text:10001886
.text:10001886                      loc_10001886:                           ; CODE XREF: WriteFile_0+E3â†“j
.text:10001886 89 C1                                mov     ecx, eax
.text:10001888 80 C1 84                             add     cl, 84h
.text:1000188B 32 4C 04 24                          xor     cl, [esp+eax+48h+var_24]
.text:1000188F 80 F1 78                             xor     cl, 78h
.text:10001892 88 4C 04 24                          mov     [esp+eax+48h+var_24], cl
.text:10001896 40                                   inc     eax
.text:10001897 75 ED                                jnz     short loc_10001886
.text:10001899 8D 44 24 18                          lea     eax, [esp+48h+var_30]
```

Pressing Shift-E, we can dump out the bytes.

The following is what we want.
C744240C57736B77C744241061436F6B66C74424149D0089C6B8F5FFFFFFC74424184C6E6367C744241C486C6475C7442420998B83BA885C2424F30F7E44240D660F60C0660FEF0560F10710660FDB0570F10710660F67C0660FD644240D89C180C184324C042480F178884C04244075ED8D442418


Next, we can run this in the emulator (This script)

$python ./emulator.py <hex_bytes_above>

"""




DEBUG =True 
ENABLE_IPYTHON =False 
#DEBUG = False 
## https://www.youtube.com/watch?v=-CNy4qh08iU


"""
# SELECT IN IDA FROM START TO END> REMEMBER FOR THE XMM0 ONE 
# YOU WILL NEED THE MOVAPS INSTRUCTION BEFORE THAT TOO

from binascii import hexlify
def get_bytes_from_selection():
    start = read_selection_start()
    end = read_selection_end()
    bytes_to_extract = end-start
    print("Bytes to extract : "+ str(bytes_to_extract))
    extracted_bytes = get_bytes(start,bytes_to_extract)
    return str(hexlify(extracted_bytes))[2:-1]
    
print(get_bytes_from_selection())
"""


from unicorn import *
from unicorn.x86_const import *
from binascii import unhexlify
from capstone import *
import IPython
import re, sys



uc = Uc(UC_ARCH_X86, UC_MODE_32)
md = Cs(CS_ARCH_X86, CS_MODE_32)
states = []

def get_register_names():
    """
    Returns a dictionary mapping register constants to their names.
    """
    return {
        UC_X86_REG_EAX: "eax",
        UC_X86_REG_EBX: "ebx",
        UC_X86_REG_ECX: "ecx",
        UC_X86_REG_EDX: "edx",
        UC_X86_REG_ESI: "esi",
        UC_X86_REG_EDI: "edi",
        UC_X86_REG_ESP: "esp",
        UC_X86_REG_EBP: "ebp",
        UC_X86_REG_EIP: "eip",
        UC_X86_REG_XMM0: "xmm0"
    }

class EmulatorState:
    def __init__(self, uc, disassembly, stackData):
        self.registers = self.capture_registers(uc)
        self.disassembly = disassembly
        self.stackData = stackData
    
    def capture_registers(self, uc):
        """
        Captures the current value of the registers.
        """
        reg_names = get_register_names()
        regs = {}
        for reg_id, reg_name in reg_names.items():
            regs[reg_name] = hex(uc.reg_read(reg_id))
        return regs


if len(sys.argv) < 2:
    print("Usage: %s <hex_bytes>" % sys.argv[0])
    sys.exit(1)

CODE = unhexlify(sys.argv[1])


# Setup stack
stack_base = 0x100000
stack_size = 0x10000

# Memory map the stack
uc.mem_map(stack_base, stack_size)
uc.mem_write(stack_base, b"\x00"*stack_size)

# Memory map the .rdata section
PAGE_SIZE = 0x1000
rdata_base = 0x10000000
rdata_size =    0xf00000
offset =        0x7F11C

# Memory map the aligned address range
uc.mem_map(rdata_base, rdata_size)
uc.mem_write(rdata_base, b"\x00"*rdata_size)

# Write the values of xmm0 
data = unhexlify("000000000000000000000000a74b071012520710a18c0710029407100000000000000000735d0710ade707107594071000000000000000000000000000000000000000000100020003000400050006000700f800ff00ff00ff00ff00ff00ff00ff00ff00530053002e004c004f004700000000005300640042006200660070006d005b007a00600078006600600068007500760053006400520064006600550078006200436e6b6a656b6e4761676b5b634c6074476472446b68676a666d4266626845002d006e0065007400000063006d0064002e0065007800650020002f00630020007300630068007400610073006b0073002e0065007800650020002f0063007200650061007400650020002f007300630020006d0069006e0075007400650020002f006d006f0020003300300020002f0074006e00200022000000220020002f0074007200200022006e006500740073006800200069006e0074006500720066006100630065002000730065007400200069006e00740065007200660061006300650020002200220022000000220022002200200065006e00610062006c0065006400220020002f00720075002000530059005300540045004d0020002f00460026007300630068007400610073006b0073002e0065007800650020002f00720075006e0020002f0074006e0020002200000053006500630075007200690074007900200057004900460049002000530063007200690070007400000057006900720065006c0065007300730020004e006500740077006f0072006b00200043006f006e006e0065006300740069006f006e000000530065006300750072006900740079002000570049004600490032002000530063007200690070007400000057006900720065006c0065007300730020004e006500740077006f0072006b00200043006f006e006e0065006300740069006f006e002000320000005300650063007500720069007400790020005700490046004900330020005300630072006900700074000000570069002d0046006900000031000000300000002200000057161a183f131b0b2c183b0018071b334d0a12091539030d1d2319221d17173257626b714268745a61656d6169406c5b4d006c0078006c0068006b00670026003d0025003a002d0024006c0061005c004000520046005c0056005b005300020053004c00440051005300460054004c005400460063006e007e0060007d005e00560047006e007c005a00430053004b0056005e004e001d00790047004e004d004f005100470057007800710043005b005b004200450043000c0079004b00b20f3b00230055006c006a00630069007e007b002b00440059002c002a006a001f00560047006e0062005d005900520056004f00480066007e0049004d004c0044004e00570074004000560054004f004600460077006300430058004a005c00bf0fb50fa70ff20f860fb10fa30fa20fb00fb60fbc0fa90f810fe90ff10fee0f9d0f950fb00fa70fb70fe40f860fa10fac0fa60fbf0f960f9d0fa30fbc0fba0fd10fa00f9f0f930f810f920f980f840f940fb60fbc0fa90f810f890fac0fbb0fb30fe00f820fa50fa00faa0fb30f9a0f990fa70fb80fbe0fed0f9c0fa30faf0f850f526665467662677d6d406f74497759002500770067006800740022005a000900457b72646a6343677e62786262626b5f6e007700660069006800290062006500476676486b6373656d436b6368636b66576a6c4d7073764a64647968446e605553006600610028004000620075007d0032002b002f003f0022003d005600140061007300720069006d00640067007d00610064006400220063006c007a00540044001e00410041004600520057005400530066006100280057006e0072006c0002001d0000006d00110040004500390066006a006e0060006a0066006b006c00576a6c4d70737646786e645f697e7b54576a6c4d7073765a6d7f457d7866615f576a6c4d707376486c6f58687d7a6b42576a6c4d7073765a6d656e5f697e7b54576a6c4d7073765b6d686f647a6a5c54576a6c4d707376587d6e7874446a6f55576a6c4d7073765b6d6a6e496d7b6f0025007600710060007600770074006600250062006e0069007100740063007b007b007b00780062006a0066006200540053006c00640071007300660074006c0070006a006c0062002400360034003e0026003b0024003d0022003e002e001c005e001300070015000a00590043005500180009001a00030052004a0052002100640066006e0025002e0029002c00290027006d002a0022007f002f00210040007200670022002a007500270029007a0057626b71426874447d677e647c636b7e546670686d69677d6d5f627f696e6a00476676436d6b63487c7f78646e7a7a54303132333435363738394142434445464748494a4b4c4d4e4f505152535455565758595a6162636465666768696a6b6c6d6e6f707172737475767778797a00003a005c00500072006f006700720061006d0044006100740061005c0000003a005c00550073006500720073005c0000000d000a0000002500770073000000290000003b00200000002a002f002a0000002c005c00000000000000000000000000496f574b555c5652425c75455d415b504464525a48587949514d5f5455596156536472416d696f4a7c7d7c666e780616010006000700040005000a000b000800476472416d696f4a7c7d7c666e78061652646b6872604e627a6c6d7b637f0b245c002a002e002a0000002500770073005c0025007700730000000000000000005300640042006200660070005d006b004a00500048005600500058005500560053006400520064006600550048005200517467717549617c4c6c7c62777041004764765563617b626d40646d7b677b7647647647657e65497a6c6f5864747572466d7770644b67636d4b7f6d727064644373676278684a667a6c697f7b676f405349446a6068417f6d7b6b7f7d7a78405c004400650076006900630065005c0046006c006f007000700079000000530048004f00500054000000770069006e0073007400610030005c00640065006600610075006c00740000002500730000002a002e002a00000000000000000000000103192002700000000000000000000043756364706e4468656a6a5d656377464368686b61687e4769626b695c7a62744762724a726e7865697f7e6868417762546274686d656b7d6d5f7c626f7661625c005c002e005c0070006900700065005c0061002500640000005c005c002e005c0070006900700065005c00620025006400000043004d0044002e0045005800450000000000000000000000000000005c005d0028005b0074006c007a006e00540068002b003d0022003f004a00360022003f0024004f00310027003400290054006b002b003d0022003f004a0036002500620069006a00770075006f006800476676526d6962667f784e647e6a6d65476676567d74726c654f637f696c7a7e476676486b6373656d4d636169416f7c476676486b6373656d436b6368636b50476676466b6a767c7c6e78436d626b46517667777d57637b6e6478606d616d744f73676b5475696a6d78795963646b7f476676467175746c667f5a7f636c6b624c6c6d6e7177567b617d636169686b474167687077735266636e645d7e66787852666554716274705e6a6678694a764652666541616b637d6d5d6b61796a5900456d77685475696a6d787940636b7b7d436c41776166726c416579796d616d7452776e4b705472687c7e7959634b61625750434261734a687b7f4f7f7e607c00480041005200440057004100520045005c004400450053004300520049005000540049004f004e005c00530059005300540045004d005c00430045004e005400520041004c00500052004f0043004500530053004f0052005c00300000007e004d0048005a00000043004c00530049004400000053006f006600740077006100720065005c0043004c00410053005300450053005c006d0073002d00700075000000250032002e0032005800250032002e0032005800250032002e0032005800250032002e0032005800250032002e0032005800250032002e0032005800250032002e0032005800250032002e003200580000005c0044006f00630075006d0065006e0074007300200061006e0064002000530065007400740069006e00670073005c0041006c006c002000550073006500720073005c004100700070006c00690063006100740069006f006e002000440061007400610000005c00500072006f006700720061006d0044006100740061000000530053002e004c004f00470000004973576f77363450726f63657373000000000000050053004f004600540057004100520045005c004d006900630072006f0073006f00660074005c00570069006e0064006f00770073005c00430075007200720065006e007400560065007200730069006f006e005c0050006f006c00690063006900650073005c00530079007300740065006d00000045006e00610062006c0065004c0055004100000043006f006e00730065006e007400500072006f006d00700074004200650068006100760069006f007200410064006d0069006e0000002500610070007000640061007400610025005c00520065006e006400650072005c000000250034002e00340064002d00250032002e00320064002d00250032002e00320064002000250032002e00320064003a00250032002e00320064003a00250032002e003200640000006e74646c6c2e646c6c004e74576f7736345175657279496e666f726d6174696f6e50726f636573733634004e74576f773634526561645669727475616c4d656d6f72793634004e745175657279496e666f726d6174696f6e50726f63657373006f00700065006e0000005300430048005400410053004b0053002e00650078006500000020002f00630072006500610074006500000020002f007300630020006d0069006e0075007400650020002f006d006f00200031003000000020002f0074006e0020002200570069006e0064006f007700730020004500640067006500200055007000640061007400650073002200000020002f007400720020000000640065006c00200025003000000020002f00720075006e00000020002f00630020000000250063006f006d00730070006500630025000000530079007300740065006d005c00430075007200720065006e00740043006f006e00740072006f006c005300650074005c0043006f006e00740072006f006c005c004e006500740077006f0072006b00000061006c006c006f0077000000250064000000090000000d000a0000000000220022002200220025007300220022002200200025006400220000002553002f00000000000057005e004800580079005f0053004d0077005e004800580059005f0053004d004e005a004c0052004b005a004c005c005d0053005f0041001a0057005300450053005000580049004b005a0048005c0064007a005f00560046005c0041005e0056005b0072007a00450045004e0046005f0054007a00660051005100500044004e00ab008800b800ae00a800b300b60025007500730065007200700072006f00660069006c00650025005c000000250061006c006c0075007300650072007300700072006f00660069006c00650025005c00000032002e00640061007400000035002e0064006100740000006f00700065006e000000250063006f006d007300700065006300250000002f0063002000640065006c0020002f00460020002f00710020002f00410020002f00530020000000250073002500730000002200250073002200200025006400000025007700730020002500640000005c005c002e005c00250077007300000025007700730022002500770073002200000063006d0064002e0065007800650020002f00630020007300630068007400610073006b0073002e0065007800650020002f0063007200650061007400650020002f007300630020006d0069006e0075007400650020002f006d006f0020003300300020002f0074006e00200022000000220020002f0074007200200022006e006500740073006800200069006e0074006500720066006100630065002000730065007400200069006e00740065007200660061006300650020002200220022000000220022002200200065006e00610062006c0065006400220020002f00720075002000530059005300540045004d0020002f00460026007300630068007400610073006b0073002e0065007800650020002f00720075006e0020002f0074006e0020002200000053006500630075007200690074007900200057004900460049002000530063007200690070007400000057006900720065006c0065007300730020004e006500740077006f0072006b00200043006f006e006e0065006300740069006f006e000000530065006300750072006900740079002000570049004600490032002000530063007200690070007400000057006900720065006c0065007300730020004e006500740077006f0072006b00200043006f006e006e0065006300740069006f006e002000320000005300650063007500720069007400790020005700490046004900330020005300630072006900700074000000570069002d0046006900000053006f006600740077006100720065005c004d006900630072006f0073006f00660074005c00570069006e0064006f00770073005c00430075007200720065006e007400560065007200730069006f006e005c0055006e0069006e007300740061006c006c005c007b00410031003600330039003000460043002d0039004400380031002d0034003300420031002d0038004100330043002d003800320038003000320046003600300038003100390033007d00000055006e0069006e007300740061006c006c0053007400720069006e006700000053006f006600740077006100720065005c0043006c00610073007300650073005c006d0073006300660069006c006500000053006f006600740077006100720065005c0043006c00610073007300650073005c006d0073006300660069006c0065005c007300680065006c006c005c006f00700065006e005c0063006f006d006d0061006e006400000063006d0064002e0065007800650020002f00630020006500760065006e0074007600770072002e00650078006500000053004f004600540057004100520045005c0043006c00610073007300650073005c006d0073002d00730065007400740069006e0067007300000063006d0064002e0065007800650020002f00630020007300640063006c0074002e00650078006500000053006f006600740077006100720065005c0043006c00610073007300650073005c0046006f006c006400650072005c007300680065006c006c005c006f00700065006e005c0063006f006d006d0061006e006400000053006f006600740077006100720065005c0043006c00610073007300650073005c006d0073002d00730065007400740069006e00670073005c007300680065006c006c005c006f00700065006e005c0063006f006d006d0061006e0064000000440065006c0065006700610074006500450078006500630075007400650000002500770069006e0064006900720025005c00730079007300740065006d00330032005c0066006f006400680065006c007000650072002e0065007800650000000103192001100000000000000000000001031920021000000c00000000000000476f6d5f5d53735c5554484c674357454766766e454c4a5c55765f41465e55424766766e454c4a5c557f5f5355425a452500740065006d00700025005c0000000d000a000000700069006e00670020003100320037002e0030002e0030002e00310020002d006e002000350020003e0020006e0075006c002000320020003e0020006e0075006c000000640065006c0020002a002e002a0020002f00660020002f00730020002f00710020002f00610000006300640020002e002e000000640065006c002000250030000000530079007300740065006d005c00430075007200720065006e00740043006f006e00740072006f006c005300650074005c0043006f006e00740072006f006c005c004e006500740077006f0072006b00000061006c006c006f0077000000640065006c005f0000002e006200610074000000000052756e4419093d101509081e07061f1852756e4013100e0d1d0a09390113101252756e47191e1112080b1f0807370311735621654054234c24504825613363350000000000000000000000000000000043736b6e78685e6467657e727865212120002f00630020007400610073006b006b0069006c006c0020002f00740020002f00660020002f00700069006400200025006400000020002f00630020007400610073006b006b0069006c006c0020002f00740020002f00660020002f0069006d0020002500770073000000250063006f006d007300700065006300250000006f00700065006e000000000000000000537a6a4872737b777c7b7371516b7174477a6a5e6969687c7663427d6676737545004e0061006d0065003a002000250073000000450041006400640072003a00200030007800250070002c000000450043006f00640065003a00200030007800250070002c0000002a0000002323232323232323006a696265457135364d0025733a25640025733a25643a25643a25733a25733a2573000053006f006600740077006100720065005c0043004c00410053005300450053005c006d0073002d00700075005c00500052004f00580059000000000000000000000000000000000000000000000000000000000001000000536472536c776f6a6c597c66637f7b67496f7262766b6f7f4b666061696e6652496f7262766b6f7f4b65617c6945737d487572774b756f655a6c7f7a697e6652496f7262766b6f7f5b6c7a407c797b7c4875727745616e596d787b6a7f795a76487572775760646f5a6c7f7a697e6656496f7262766b6f7f5f7b677b694b7b7f48757277416b6e596d787b6a7f795300496f7262766b6f7f5a6c6f6b4a647e76456f7262764678627c606d6e605e77704c646771614678627c606d6e605e77702573000d0a0025733a2564004d6f7a696c6c612f352e30202857696e646f7773204e542031302e303b57696e36343b783634294170706c655765624b69742f3533372e33360025382e387800504f5354006a73702d7365006a73702d7374006a73702d7369006a73702d736e0025733a2025640d0a25733a2025640d0a25733a2025640d0a25733a2025640d0a00436f6f6b69653a202573002a2f2a0000000057524f486979457d6d7b9a9684859797434f4e4e4543542025733a256420485454502f312e310d0a00436f6e74656e742d6c656e6774683a20300d0a00436f6e74656e742d547970653a20746578742f68746d6c0d0a0050726f78792d436f6e6e656374696f6e3a204b6565702d416c6976650d0a0050726f78792d417574686f72697a6174696f6e3a2042617369632025730d0a00485454502f312e30203230302000485454502f312e3120323030200000000000000000000000000000005500500040005200420040005a0040004e005200550077007500630069007900496d76687e616b7d4b636f565f74595f5c0032002c003d0050007f0052000900466a6c694a667c7a7c5d6559415a5366466a6c69426a767d5e64664059526100466a6c695a60627c656e49595b445300476676416368676a69674e475d4153624e006600700062007b006e0078006c006d006f00630041001a00530057004500570062007400680049006b0067007d00770062007400680069006b0067007d004766765969627e4f61676f7b555a536646006e00760042007c007b006700660053006600460068006e007a00690059007a0062007c005c00580052005100540053006c00640079007b006e007c006c0054004600630056004600580045005e00560047006e006a00550051005a0056004f0048006600660051005500540044004e005700740048005e005c0047004600d19600006f00700065006e002d005500000055007300620020004400690073006b0000002500610070007000640061007400610025005c00520065006e006400650072005c00000025007500730065007200700072006f00660069006c00650025000000250061006c006c0075007300650072007300700072006f00660069006c00650025005c00000050006c0075007300430061006300680065005c0000005b002e005300680065006c006c0043006c0061007300730049006e0066006f005d000000680074007400700073003a002f002f007700770077002e006d006900630072006f0073006f00660074002e0063006f006d000000530079007300740065006d005c00430075007200720065006e00740043006f006e00740072006f006c005300650074005c0043006f006e00740072006f006c005c004e006500740077006f0072006b000000560065007200730069006f006e00000053006f006600740077006100720065005c004d006900630072006f0073006f00660074005c00570069006e0064006f00770073005c00430075007200720065006e007400560065007200730069006f006e005c00520075006e000000410041004d00200055007000640061007400650000004100630072006f00520064003300320000006100630072006f007400720061007900730000004100630072006f006200610074002000520065006100640000004100630072006f006400610074002000520065006100640000006100630072006f00640061007400200052006500610064000000410064006f00620065006c006d00000053006d0061006400610076000000520061007a0065007200000052007a004300650066000000430065006600520065006e00640065007200000052007a0065007200500072006f006300650073007300000043006500660052007a00000058003300320064006200670000007600730074006f006f006c005f007800380036000000570069006e0064006f00770073004e00540000006e007600630070006c00750069000000520045004300590043004c004500520053002e00420049004e0000005c005c002e005c0063003a000000250063006f006d007300700065006300250020002f00710020002f00630020000000730079007300740065006d0069006e0066006f0000006900700063006f006e0066006900670020002f0061006c006c0000006e0065007400730074006100740020002d0061006e006f00000061007200700020002d00610000007400610073006b006c0069007300740020002f007600000020003e000000640065006c00200025003000000025007e006400700030000000a000a0000000520065006d006f00760000004400690073006b0000002e006c006e006b0000002e0073006300720000002e0064006c006c0000006400650073006b0074006f0070002e0069006e00690000004400520049005600450000005500530042002000440072006900760065000000320030003200310045006400750063006100740069006f006e0000002e0063006d00640000007000320000002e0045005800450000002e0053004300520000002e0044004c004c0000002e0043004d00440000002e0042004100540000002e00480045004c005000000055007300620020004400690073006b002800000032002e00640061007400000035002e00640061007400000036002e0063006d00640000002e00650078006500000053006f006600740077006100720065005c004d006900630072006f0073006f00660074005c00570069006e0064006f00770073005c00430075007200720065006e007400560065007200730069006f006e005c004500780070006c006f007200650072005c0041006400760061006e006300650064000000480069006400640065006e000000530068006f00770053007500700065007200480069006400640065006e0000004800690064006500460069006c00650045007800740000002e006400610074000000520065006d006f007600610062006c00650020004400690073006b005c00000033002e0030005c000000410056004100530054005c00500072006f00740065006300740069006f006e00200066006f00720020004100750074006f00720075006e005c00000053004d0041004400410056005c0053004d0041004400410056005c000000250063006f006d007300700065006300250000002f00630020007200640020002f00730020002f0071002000000074006d00700063005f00000074006d0070005f0000002e0062006100740000002500740065006d00700025005c0000000d0a64656c202530000055007300620020004400720069007600650000005500530042005f004e004f00540049004600590032005f0049004e0046005f0000002e0069006e0066006f0000005500530042005f004e004f00540049004600590032005f0043004f0050005f0000004b006100730070006500720073006b0079005c0000005500730062002000440072006900760065005c00000031002e0030005c000000530059004d0041004e005400450043002e004500580045000000410064006f0062006500480065006c007000650072002e006500780065000000410064006f006200650055007000640061007400650073002e006500780065000000410064006f00620065005500700064006100740065002e006500780065000000410041004d00200055007000640061007400650073002e006500780065000000410041004d0020005500700064006100740065002e0065007800650000004100630072006f0052006400330032002e0065007800650000006100630072006f00740072006100790073002e0065007800650000004100630072006f00620061007400200052006500610064002e006500780065000000410064006f00620065006c006d002e00650078006500000053006d0061006400610076002e00650078006500000073007600630068006f00730074002e00650078006500000064006c006c0068006f00730074002e00650078006500000064006c006c0068006f007300740073002e006500780065000000630061006c0063002e00650078006500000052007a004300650066002e006500780065000000430065006600520065006e006400650072002e00650078006500000052007a00500072006f0063006500730073002e00650078006500000052007a0065007200500072006f0063006500730073002e0065007800650000006d00660070006d0070002e00650078006500000073006500720076006900630065005f0068006f00730074002e0065007800650000006e006f00740065007000610064002e0065007800650000006d0073006500780070006500720074002e00650078006500000076006900760061006c00640069002e006500780065000000430055005a002e006500780065000000530079006d0061006e007400650063002e006500780065000000730079006d0061006e0074006500630073002e0065007800650000005700650043006800610074002e0065007800650000004f0070006500720061002e0065007800650000004d006900630072006f0073006f0066007400450064006700650073002e006500780065000000410064006f00620065005f006c006900630065006e00730069006e0067005f00770066002e0065007800650000006700750070002e006500780065000000530069006c007600650072006c0069006700680074002e0043006f006e00660069006700750072006100740069006f006e002e00650078006500000043003a005c00500072006f006700720061006d0044006100740061005c00520061007a0065007200000043003a005c00500072006f006700720061006d0044006100740061005c00520061007a0065007200430065006600500072006f006300650073007300000043003a005c00500072006f006700720061006d0044006100740061005c0043006500660052007a00000043003a005c00500072006f006700720061006d0044006100740061005c00440065006200750067005200650070006f0072007400000043003a005c00500072006f006700720061006d0044006100740061005c0052007a0065007200500072006f006300650073007300000043003a005c00500072006f006700720061006d0044006100740061005c00530079006d0061006e00740065006300530045006e00640070006f006e00690074005c00420069006e005c00000043003a005c00500072006f006700720061006d00440061007400610000005300430048005400410053004b0053002e0065007800650000002000220075006400690073006b005f003100220000002000220075006400690073006b005f0031002e0030003000220000002000220075006400690073006b005f0031002e0030003200220000002000220075006400690073006b005f0031002e0030003300220000002000220075006400690073006b005f00320022000000200022005a00420054005f0030002e00310022000000200022004c004b00550046004f00520059004f0055005f00310022000000200022004c004b00550046004f00520059004f0055005f00320022000000200022004100630072006f0052006400330032002200000020002f00640065006c00650074006500000020002f0074006e00000020002f006300200000006f00700065006e000000250063006f006d00730070006500630025005c000000250077007300280025006400540042002900000025007700730028002500640047004200290000002500770073002800250064004d00420029000000250077007300250077007300000025007700730025007700730025007700730000002500770073002500770073002500770073005c0025007700730000002500770073002500770073005c00000070000000250063003a005c0000005f0000002500770073006500640067002500640025007700730000005c005c002e005c0000002500530000000000437367627060516e767d756c596549005473636d776967737d547f686f7c797a446871736571656f557c69687d7a7b487300740061007400690063000000000000000000841c0810901c08109c1c0810a81c08106a0061002d004a00500000007a0068002d0043004e000000")
uc.mem_write(rdata_base + offset, data)


# In case of unmapped stack location
currentEsp = stack_base + stack_size // 2

# Set the initial stack pointer
uc.reg_write(UC_X86_REG_ESP, currentEsp)

# Create Code page
code_address = 0x4000000
code_size = 0x1000000

# Map the code page
uc.mem_map(code_address, code_size)
uc.mem_write(code_address, b"\x00"*code_size)

# Write the code to code page
uc.mem_write(code_address, CODE)

def HookCode(emu,address,size, user_data):
    #print(f"Executing at {address:x}, instruction size: {size}")
    code = emu.mem_read(address,size)
    inst = next(md.disasm(code,address),None)
    instruction_text =  (f"0x{inst.address:x}:\t{inst.mnemonic}\t{inst.op_str}")
    stack_data = emu.mem_read(emu.reg_read(UC_X86_REG_ESP),0xf0)

    states.append(EmulatorState(emu, instruction_text, stack_data))

    
if DEBUG:
    # https://hackmd.io/@K-atc/rJTUtGwuW?type=view
    # https://github.com/unicorn-engine/unicorn/blob/master/bindings/python/sample_x86.py
    uc.hook_add(UC_HOOK_CODE, HookCode)

uc.emu_start(code_address, code_address + len(CODE))
stack_dump = uc.mem_read(uc.reg_read(UC_X86_REG_ESP),0x1000)


def extract_printable_strings(data: bytearray):
    # Regex pattern for printable ASCII characters
    ascii_pattern = re.compile(b'[\x20-\x7E]+')
    ascii_matches = ascii_pattern.findall(data)
    ascii_strings = [match.decode('ascii') for match in ascii_matches]

    for i in ascii_strings:
        if len(i) > 1:
            print("[ASCII] : " + i)
    
    # Regex pattern for UTF-16 little-endian encoded strings
    # This assumes little-endian encoding; adjust if big-endian (\x00[\x20-\x7E]) is needed
    unicode_pattern = re.compile(b'(([\x2e-\x7f]\x00)+)')
    unicode_matches = unicode_pattern.findall(data)
    for i in unicode_matches:
        for j in i:
            unicode_string = j.decode('utf-16-le')
            if len(unicode_string) > 1:
                print("[UNICODE] : " + unicode_string)


#extract_printable_strings(stack_dump)
extract_printable_strings(stack_dump)
if DEBUG:
    for i in states:
        print("")
        print(i.disassembly)
        print(i.registers)
        print(i.stackData)
if ENABLE_IPYTHON: 
    IPython.embed()

